<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-i18n="profile.title">Профиль — PADOBI PC</title>
  <meta name="description" content="Профиль пользователя — PADOBI PC" />
  <style>
    :root{
      --bg:#000;
      --panel:#0b0b0b;
      --card:#0f0f0f;
      --muted:#a9a9a9;
      --text:#fff;
      --brand:#0ff;
      --accent:#a855f7;
      --radius:18px;
      --shadow:0 16px 48px rgba(0,0,0,.75);
      --container:1200px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.5;
    }
    a{color:inherit;text-decoration:none}
    img{display:block;max-width:100%}
    .container{max-width:var(--container);margin:0 auto;padding:0 20px}

    /* Header: consistent with main page */
    header{
      position:sticky;top:0;z-index:120;background:var(--bg);
      border-bottom:1px solid rgba(255,255,255,0.03);
      box-shadow:0 0 20px rgba(0,255,255,.04);
      backdrop-filter: blur(4px);
    }
    .nav{height:72px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:12px;font-weight:900;letter-spacing:.6px;cursor:pointer}
    .brand__logo{width:42px;height:42px;border-radius:10px;overflow:hidden;flex-shrink:0;box-shadow:0 0 10px rgba(0,255,255,.12)}
    .brand__logo img{width:100%;height:100%;object-fit:cover;display:block}
    .brand__text{font-size:18px;text-transform:uppercase}
    .actions{display:flex;align-items:center;gap:10px}
    .icon-btn{position:relative;display:grid;place-items:center;width:42px;height:42px;border-radius:10px;background:var(--panel);border:1px solid #232323;cursor:pointer;transition:.18s;overflow:visible}
    .icon-btn:hover{transform:translateY(-2px);box-shadow:0 0 18px rgba(0,255,255,.12)}
    .badge{position:absolute;top:-6px;right:-6px;background:var(--brand);color:#000;font-size:11px;font-weight:800;padding:2px 6px;border-radius:999px;border:2px solid var(--panel);box-shadow:0 0 10px var(--brand)}
    .dropdown{position:relative}
    .dropdown-menu{display:none;position:absolute;right:0;top:48px;background:var(--panel);border:1px solid #232323;border-radius:10px;min-width:200px;overflow:hidden;box-shadow:var(--shadow);z-index:110}
    .dropdown.open .dropdown-menu{display:block}
    .dropdown-menu a{display:block;padding:12px 16px;color:var(--text);font-size:14px}
    .lang{display:flex;gap:8px;align-items:center}
    .lang button{height:34px;padding:0 12px;border-radius:8px;border:1px solid #232323;background:#0d0d0d;color:#ddd;cursor:pointer;font-weight:700;letter-spacing:.4px;transition:.12s}
    .lang button.active{background:#fff;color:#000;box-shadow:0 0 12px rgba(0,255,255,.18)}
    .lang button:focus{outline:2px solid rgba(0,255,255,.06);outline-offset:2px}

    /* small avatar button in header */
    .profile-btn{
      width:40px;height:40px;border-radius:10px;padding:0;border:none;background:transparent;display:grid;place-items:center;cursor:pointer;border:1px solid rgba(255,255,255,0.03);overflow:hidden;
    }
    .profile-btn img{width:100%;height:100%;object-fit:cover;display:block;border-radius:8px}

    /* Profile layout */
    main{padding:40px 0}
    .profile-wrap{max-width:980px;margin:36px auto;padding:28px;border-radius:16px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border:1px solid rgba(255,255,255,0.03);box-shadow:var(--shadow);display:grid;grid-template-columns:320px 1fr;gap:28px}
    @media (max-width:920px){ .profile-wrap{grid-template-columns:1fr} .profile-actions{justify-content:center} }
    .left{display:flex;flex-direction:column;align-items:center;gap:16px;padding:8px}
    .avatar{width:160px;height:160px;border-radius:18px;overflow:hidden;border:2px solid rgba(0,255,255,0.12);background:#111;display:flex;align-items:center;justify-content:center;box-shadow:0 10px 30px rgba(0,0,0,.6)}
    .avatar img{width:100%;height:100%;object-fit:cover}
    .upload-btn{display:inline-block;padding:10px 14px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text);cursor:pointer}
    .upload-btn:hover{border-color:var(--brand);box-shadow:0 0 12px rgba(0,255,255,.06)}
    .username-large{font-size:20px;font-weight:800;margin-top:6px}
    .muted{color:var(--muted);font-size:14px}

    .right{padding:6px 4px;display:flex;flex-direction:column;gap:16px}
    .panel{background:var(--panel);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.02)}
    .panel h3{margin:0 0 8px;font-size:16px}
    .meta-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .stat{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);min-width:140px}
    .stat .num{font-weight:800;font-size:18px}
    .form-inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .form-inline input[type="text"], .form-inline input[type="email"], .form-inline input[type="tel"]{padding:10px;border-radius:10px;border:1px solid #222;background:#0d0d0d;color:var(--text)}
    .btn-primary{padding:10px 16px;border-radius:10px;border:none;background:var(--brand);color:#000;font-weight:800;cursor:pointer;box-shadow:0 0 16px rgba(0,255,255,.45)}
    .btn-outline{padding:9px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)}
    .danger{background:#2b2b2b;color:var(--muted)}

    @media (max-width:480px){
      .avatar{width:120px;height:120px}
      .profile-wrap{padding:18px}
    }

    /* hidden file input */
    input[type="file"]{display:none}

    /* Chat (same as main) */
    .chat-btn{position:fixed;bottom:20px;right:20px;width:64px;height:64px;border-radius:50%;background:var(--brand);display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 0 26px var(--brand),0 0 38px rgba(0,255,255,.35);transition:.25s;z-index:120}
    .chat-btn:hover{transform:scale(1.06)}
    .chat-btn svg{stroke:#000}
    .chat-window{position:fixed;bottom:96px;right:20px;width:320px;background:var(--panel);border:1px solid #232323;border-radius:16px;box-shadow:0 16px 48px rgba(0,0,0,.7);display:none;flex-direction:column;overflow:hidden;z-index:115;max-height:60vh}
    .chat-header{background:linear-gradient(90deg,var(--brand),rgba(255,255,255,0.5));color:#000;font-weight:800;padding:10px;display:flex;justify-content:space-between;align-items:center}
    .chat-close{background:none;border:none;font-size:18px;cursor:pointer}
    .chat-messages{flex:1;padding:10px;max-height:260px;overflow-y:auto;color:var(--text);display:flex;flex-direction:column;gap:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
    .msg{margin:6px 0;padding:8px 12px;border-radius:10px;max-width:80%;word-break:break-word}
    .msg.bot{background:#222;align-self:flex-start;color:var(--text)}
    .msg.user{background:var(--brand);color:#000;align-self:flex-end;font-weight:700}
    .chat-input{display:flex;border-top:1px solid #232323;padding:10px;gap:8px;background:linear-gradient(180deg, transparent, rgba(255,255,255,0.01))}
    .chat-input input{flex:1;padding:10px;border:none;background:#111;color:var(--text);outline:none;border-radius:8px}
    .chat-input button{background:var(--brand);border:none;padding:8px 12px;cursor:pointer;border-radius:8px}
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="container nav" role="banner">
      <a class="brand" href="index.html" aria-label="PADOBI PC — Home">
        <span class="brand__logo"><img src="logo.jpg" alt="Padobi logo" /></span>
        <span class="brand__text" data-i18n="site.brand">PADOBI PC</span>
      </a>

      <div class="actions" role="navigation" aria-label="Header actions">
        <div class="lang" aria-label="Language switch">
          <button type="button" data-lang="ru" aria-pressed="false">RU</button>
          <button type="button" data-lang="ua" aria-pressed="false">UA</button>
          <button type="button" data-lang="en" aria-pressed="false">EN</button>
        </div>

        <!-- small avatar/profile button (will be filled with user's avatar if present) -->
        <button id="profileBtn" class="profile-btn" title="Profile">
          <!-- fallback icon -->
          <img id="smallAvatar" src="" alt="profile" style="display:none" />
          <svg id="profileIcon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><circle cx="12" cy="7" r="4"/><path d="M6 21a6 6 0 0 1 12 0"/></svg>
        </button>

        <button class="icon-btn" title="Cart" onclick="window.location.href='cart.html'" aria-label="Cart">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M6 6h15l-1.5 9h-12z"/><path d="M6 6l-2-3"/><circle cx="9" cy="21" r="1.5"/><circle cx="18" cy="21" r="1.5"/></svg>
          <span class="badge" id="cartCount">0</span>
        </button>

        <div class="dropdown" id="menuDropdown">
          <button class="icon-btn" id="menuBtn" aria-expanded="false" aria-controls="menu" title="Menu">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
          </button>
          <div class="dropdown-menu" id="menu" role="menu" aria-hidden="true">
            <a href="profile.html" data-i18n="menu.profile">Профиль</a>
            <a href="cart.html" data-i18n="menu.cart">Корзина</a>
            <a href="#" data-i18n="menu.settings">Настройки</a>
            <a href="status.html" data-i18n="menu.status">Статус заказа</a>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="container">
      <section class="profile-wrap" role="region" aria-labelledby="profileTitle">
        <div class="left">
          <div class="avatar" id="avatar">
            <!-- placeholder icon -->
            <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><circle cx="12" cy="8" r="4"/><path d="M4 22c0-4 4-7 8-7s8 3 8 7"/></svg>
          </div>

          <label class="upload-btn" for="uploadAvatar" id="uploadLabel" data-i18n="profile.upload">Загрузить фото</label>
          <input id="uploadAvatar" type="file" accept="image/*" />

          <div class="username-large" id="displayName">Гость</div>
          <div class="muted" id="emailLine">—</div>
        </div>

        <div class="right">
          <div class="panel" aria-labelledby="profileTitle">
            <h3 id="profileTitle" data-i18n="profile.title_h">Профиль</h3>
            <div class="meta-row" style="margin-top:6px">
              <div class="stat">
                <div class="muted" data-i18n="profile.orders">Заказы</div>
                <div class="num" id="ordersCount">0</div>
              </div>
              <div class="stat">
                <div class="muted" data-i18n="profile.since">На сайте с</div>
                <div class="num" id="regDate">—</div>
              </div>
              <div class="stat">
                <div class="muted" data-i18n="profile.phone">Телефон</div>
                <div class="num" id="phoneLine">—</div>
              </div>
            </div>
          </div>

          <div class="panel">
            <h3 data-i18n="profile.settings">Настройки аккаунта</h3>
            <!-- removed inline onsubmit to avoid recursion bug -->
            <form id="profileForm" class="form-inline">
              <input type="text" id="inputName" placeholder="" data-i18n-placeholder="profile.name_placeholder" />
              <input type="tel" id="inputPhone" placeholder="" data-i18n-placeholder="profile.phone_placeholder" />
              <button class="btn-primary" type="submit" data-i18n="profile.save">Сохранить</button>
              <button type="button" class="btn-outline" onclick="signOut()" data-i18n="profile.logout">Выйти</button>
            </form>
          </div>

          <div class="panel">
            <h3 data-i18n="profile.support_title">Поддержка</h3>
            <div class="muted" data-i18n="profile.support_note">Если возникли вопросы — напишите нам через чат или email.</div>
            <div style="margin-top:12px;display:flex;gap:10px;" class="profile-actions">
              <!-- removed "Open chat" button; UI uses floating chat identical to main -->
              <a class="btn-outline" href="mailto:support@padobi.example" data-i18n="profile.email">support@padobi.example</a>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Floating chat widget (exact same as main page) -->
  <button class="chat-btn" id="chatToggle" aria-label="Открыть чат поддержки">
    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
  </button>

  <div class="chat-window" id="chatWindow" role="dialog" aria-label="Чат поддержки" aria-hidden="true">
    <div class="chat-header">
      <span data-i18n="chat.support">Поддержка</span>
      <button class="chat-close" id="chatClose" aria-label="Закрыть">×</button>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div class="msg bot" data-i18n="chat.greet">Здравствуйте! Чем можем помочь?</div>
    </div>
    <div class="chat-input">
      <input type="text" id="chatInput" data-i18n-placeholder="chat.input" placeholder="Введите сообщение..." aria-label="Сообщение" />
      <button id="chatSend" aria-label="Отправить">➤</button>
    </div>
  </div>

  <!-- Supabase SDK -->
  <script src="https://unpkg.com/@supabase/supabase-js"></script>

  <script>
    // -------- translations used on this page (profile + chat) --------
    const translations = {
      ru: {
        'site.brand':'PADOBI PC',
        'profile.title':'Профиль — PADOBI PC',
        'profile.title_h':'Профиль',
        'profile.upload':'Загрузить фото',
        'profile.orders':'Заказы',
        'profile.since':'На сайте с',
        'profile.phone':'Телефон',
        'profile.settings':'Настройки аккаунта',
        'profile.save':'Сохранить',
        'profile.logout':'Выйти',
        'profile.support_title':'Поддержка',
        'profile.support_note':'Если возникли вопросы — напишите нам через чат или email.',
        'profile.open_chat':'Открыть чат',
        'profile.email':'support@padobi.example',
        'profile.name_placeholder':'Имя (например, Иван)',
        'profile.phone_placeholder':'Телефон (например, +380...)',
        'menu.profile':'Профиль','menu.cart':'Корзина','menu.settings':'Настройки','menu.status':'Статус заказа',
        'chat.support':'Поддержка','chat.greet':'Здравствуйте! Чем можем помочь?','chat.input':'Введите сообщение...','chat.thanks':'Спасибо за сообщение! Мы скоро ответим.'
      },
      ua: {
        'site.brand':'PADOBI PC','profile.title':'Профіль — PADOBI PC','profile.title_h':'Профіль','profile.upload':'Завантажити фото',
        'profile.orders':'Замовлення','profile.since':'На сайті з','profile.phone':'Телефон','profile.settings':'Налаштування акаунту',
        'profile.save':'Зберегти','profile.logout':'Вийти','profile.support_title':'Підтримка','profile.support_note':'Якщо є питання — напишіть нам через чат або email.',
        'profile.email':'support@padobi.example','profile.name_placeholder':'Ім’я (наприклад, Іван)','profile.phone_placeholder':'Телефон (наприклад, +380...)',
        'menu.profile':'Профіль','menu.cart':'Кошик','menu.settings':'Налаштування','menu.status':'Статус замовлення',
        'chat.support':'Підтримка','chat.greet':'Вітаємо! Як можемо допомогти?','chat.input':'Введіть повідомлення...','chat.thanks':'Дякуємо за повідомлення! Ми скоро відповімо.'
      },
      en: {
        'site.brand':'PADOBI PC','profile.title':'Profile — PADOBI PC','profile.title_h':'Profile','profile.upload':'Upload photo',
        'profile.orders':'Orders','profile.since':'Member since','profile.phone':'Phone','profile.settings':'Account settings',
        'profile.save':'Save','profile.logout':'Sign out','profile.support_title':'Support','profile.support_note':'If you have questions — contact us via chat or email.',
        'profile.email':'support@padobi.example','profile.name_placeholder':'Name (e.g. John)','profile.phone_placeholder':'Phone (e.g. +380...)',
        'menu.profile':'Profile','menu.cart':'Cart','menu.settings':'Settings','menu.status':'Order Status',
        'chat.support':'Support','chat.greet':'Hello! How can we help you?','chat.input':'Type a message...','chat.thanks':'Thank you! We will reply soon.'
      }
    };

    const available = Object.keys(translations);
    let currentLang = localStorage.getItem('padobi_lang') || (available.includes((navigator.language||'').slice(0,2)) ? (navigator.language||'').slice(0,2) : 'ru');
    if(!available.includes(currentLang)) currentLang = 'ru';

    function setText(el, txt){ if(!el) return; el.textContent = txt; }
    function setLang(code){
      if(!translations[code]) return;
      currentLang = code;
      localStorage.setItem('padobi_lang', code);
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const key = el.getAttribute('data-i18n');
        if(key && translations[code][key] !== undefined) setText(el, translations[code][key]);
      });
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{
        const key = el.getAttribute('data-i18n-placeholder');
        if(key && translations[code][key] !== undefined) el.setAttribute('placeholder', translations[code][key]);
      });
      if(translations[code]['profile.title']) document.title = translations[code]['profile.title'];
      document.documentElement.setAttribute('lang', code);
      document.querySelectorAll('.lang button').forEach(btn=>{
        const b = btn.getAttribute('data-lang') || btn.textContent.toLowerCase();
        const active = b === code;
        btn.classList.toggle('active', active);
        btn.setAttribute('aria-pressed', active ? 'true' : 'false');
      });
      // update chat greeting bot message
      const firstBot = document.querySelector('.chat-messages .msg.bot');
      if(firstBot && translations[code]['chat.greet']) firstBot.textContent = translations[code]['chat.greet'];
    }

    // initialize language buttons early (in case)
    window.addEventListener('DOMContentLoaded', ()=> {
      document.querySelectorAll('.lang button').forEach(btn=>{
        if(!btn.hasAttribute('data-lang')) btn.setAttribute('data-lang', btn.textContent.toLowerCase());
        btn.style.pointerEvents = 'auto';
        btn.addEventListener('click', ()=> setLang(btn.getAttribute('data-lang')));
      });
      setLang(currentLang);
    });

    // -------- Supabase client (public anon key included intentionally as earlier) --------
    const supabaseUrl = "https://rjqeqffegmejiyakhxza.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJqcWVxZmZlZ21laml5YWtoeHphIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MTA2MzcsImV4cCI6MjA3MjM4NjYzN30.KuXUp9tCXmnlCMv3go89E8O_oHOvurErUkcst8UUEGc";
    const supabase = window.supabase ? window.supabase.createClient(supabaseUrl, supabaseKey) : null;

    // ---------- UI initialization and handlers ----------
    async function initProfileUI(){
      const upload = document.getElementById('uploadAvatar');
      const avatarEl = document.getElementById('avatar');
      const smallAvatarImg = document.getElementById('smallAvatar');
      const profileIcon = document.getElementById('profileIcon');
      const profileBtn = document.getElementById('profileBtn');

      // helper to set avatar in both places
      function setAvatarFromUrl(url){
        if(!url) return;
        avatarEl.innerHTML = `<img alt="avatar" src="${url}">`;
        smallAvatarImg.src = url;
        smallAvatarImg.style.display = 'block';
        profileIcon.style.display = 'none';
      }

      // upload handling: read file locally then upload to Supabase Storage and update metadata
      upload.addEventListener('change', async (e)=>{
        const file = e.target.files[0];
        if(!file) return;
        // show preview immediately
        const reader = new FileReader();
        reader.onload = ()=> {
          avatarEl.innerHTML = `<img alt="avatar" src="${reader.result}">`;
          // show temporary preview in header
          smallAvatarImg.src = reader.result;
          smallAvatarImg.style.display = 'block';
          profileIcon.style.display = 'none';
        };
        reader.readAsDataURL(file);

        // if supabase available, upload and persist
        if(!supabase){
          // no supabase: keep preview only
          return;
        }
        try {
          // get current user
          const { data: { user }, error: userErr } = await supabase.auth.getUser();
          if(userErr) throw userErr;
          if(!user) {
            alert('Сохранение аватара доступно только авторизованным пользователям.');
            return;
          }
          // prepare path (use user id)
          const fileExt = file.name.split('.').pop();
          const filePath = `avatars/${user.id}/${Date.now()}.${fileExt}`;
          // upload to storage (bucket 'avatars' must exist and be public or have a policy)
          const { error: uploadError } = await supabase.storage.from('avatars').upload(filePath, file, { upsert: true });
          if(uploadError){
            console.error('Upload error', uploadError);
            alert('Ошибка загрузки аватара: ' + uploadError.message);
            return;
          }
          // get public url
          const { data: { publicUrl } } = await (async ()=>{
            // supabase js v2 provides getPublicUrl under storage.from(bucket).getPublicUrl(path) returning { data: { publicUrl } }
            try {
              const res = supabase.storage.from('avatars').getPublicUrl(filePath);
              return { data: { publicUrl: res.data.publicUrl } };
            } catch(e) {
              return { data: { publicUrl: '' } };
            }
          })();
          if(!publicUrl){
            // fallback: create signed URL for display (optional)
            // try signed URL for 1 hour
            try {
              const { data: signed, error: signedErr } = await supabase.storage.from('avatars').createSignedUrl(filePath, 60 * 60);
              if(signedErr) throw signedErr;
              publicUrl = signed?.signedUrl || '';
            } catch(e){
              console.warn('Could not get public url', e);
            }
          }
          // Update user metadata with avatar_url
          const { error: updateErr } = await supabase.auth.updateUser({ data: { avatar_url: publicUrl } });
          if(updateErr){
            console.warn('Could not update user metadata', updateErr);
          } else {
            // ensure UI uses stored url
            if(publicUrl) setAvatarFromUrl(publicUrl);
          }
        } catch(err){
          console.error('avatar upload flow', err);
        }
      });

      // Chat handlers (same behavior as main)
      const chatToggle = document.getElementById('chatToggle');
      const chatWindow = document.getElementById('chatWindow');
      const chatClose = document.getElementById('chatClose');
      const chatSend = document.getElementById('chatSend');
      const chatInput = document.getElementById('chatInput');
      const chatMessages = document.getElementById('chatMessages');

      function appendUserMessage(text){
        const userMsg = document.createElement('div');
        userMsg.className = 'msg user';
        userMsg.textContent = text;
        chatMessages.appendChild(userMsg);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
      function appendBotMessage(text){
        const botMsg = document.createElement('div');
        botMsg.className = 'msg bot';
        botMsg.textContent = text;
        chatMessages.appendChild(botMsg);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      chatToggle && chatToggle.addEventListener('click', ()=>{
        const isOpen = chatWindow.style.display === 'flex';
        if(isOpen){
          chatWindow.style.display = 'none';
          chatWindow.setAttribute('aria-hidden','true');
        } else {
          chatWindow.style.display = 'flex';
          chatWindow.setAttribute('aria-hidden','false');
          chatInput && chatInput.focus();
        }
      });
      chatClose && chatClose.addEventListener('click', ()=>{
        chatWindow.style.display = 'none';
        chatWindow.setAttribute('aria-hidden','true');
      });
      if(chatSend){
        chatSend.addEventListener('click', ()=>{
          const text = (chatInput.value || '').trim();
          if(!text) return;
          appendUserMessage(text);
          chatInput.value = '';
          setTimeout(()=> appendBotMessage(translations[currentLang]['chat.thanks'] || 'Спасибо!'), 600);
        });
      }
      chatInput && chatInput.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter'){ e.preventDefault(); chatSend && chatSend.click(); }
      });

      // Profile form submit: update metadata (name/phone) and display "Saved" once
      const profileForm = document.getElementById('profileForm');
      profileForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const name = (document.getElementById('inputName').value || '').trim();
        const phone = (document.getElementById('inputPhone').value || '').trim();

        // optimistic UI update
        if(name) document.getElementById('displayName').textContent = name;
        if(phone) document.getElementById('phoneLine').textContent = phone;

        // attempt to update via Supabase
        if(!supabase){
          alert('Сохранено (локально)');
          return;
        }
        try {
          const updates = {};
          if(name) updates.full_name = name;
          if(phone) updates.phone = phone;
          if(Object.keys(updates).length){
            const { error } = await supabase.auth.updateUser({ data: updates });
            if(error) throw error;
          }
          // show single confirmation (not recursive)
          alert('Сохранено');
        } catch(err){
          console.error('save profile', err);
          alert('Ошибка при сохранении: ' + (err.message || err));
        }
      });

      // profile button click -> go to profile (already here) or show small menu
      profileBtn.addEventListener('click', async ()=>{
        // prefer to open profile page (we're on it), or show quick menu
        // show a tiny menu (simple): toggle dropdown
        const dropdown = document.getElementById('menuDropdown');
        if(dropdown) {
          const open = dropdown.classList.toggle('open');
          document.getElementById('menuBtn')?.setAttribute('aria-expanded', String(open));
        }
      });

      // Load existing user data
      async function loadProfile(){
        if(!supabase) return;
        try {
          const { data: { user }, error } = await supabase.auth.getUser();
          if(error) throw error;
          if(user){
            const name = user.user_metadata?.full_name || user.email || 'Гость';
            document.getElementById('displayName').textContent = name;
            document.getElementById('emailLine').textContent = user.email || '—';
            document.getElementById('regDate').textContent = user.created_at ? new Date(user.created_at).toLocaleDateString() : '—';
            document.getElementById('inputName').value = user.user_metadata?.full_name || '';
            // try multiple phone metadata fields
            const phoneVal = user.user_metadata?.phone || user.user_metadata?.phone_number || '';
            document.getElementById('inputPhone').value = phoneVal;
            document.getElementById('phoneLine').textContent = phoneVal || '—';
            document.getElementById('ordersCount').textContent = '0'; // placeholder, integrate with DB if available

            // avatar
            const avatarUrl = user.user_metadata?.avatar_url;
            if(avatarUrl){
              // prefer public URL
              document.getElementById('avatar').innerHTML = `<img alt="avatar" src="${avatarUrl}">`;
              document.getElementById('smallAvatar').src = avatarUrl;
              document.getElementById('smallAvatar').style.display = 'block';
              document.getElementById('profileIcon').style.display = 'none';
            }
          }
        } catch(err){
          console.error('loadProfile error', err);
        }
      }
      await loadProfile();
    } // end initProfileUI

    // Sign out helper
    async function signOut(){
      if(!supabase){
        window.location.href = 'index.html';
        return;
      }
      try{
        await supabase.auth.signOut();
        window.location.href = 'index.html';
      }catch(err){
        console.error('signOut', err);
        window.location.href = 'index.html';
      }
    }

    // When DOM ready, run init
    window.addEventListener('DOMContentLoaded', ()=> {
      initProfileUI().catch(e => console.error(e));

      // menu toggle global
      (function(){
        const menuBtn = document.getElementById('menuBtn');
        const menuDropdown = document.getElementById('menuDropdown');
        const menu = document.getElementById('menu');
        if(menuBtn){
          menuBtn.addEventListener('click', ()=>{
            const open = menuDropdown.classList.toggle('open');
            menuBtn.setAttribute('aria-expanded', String(open));
            if(menu) menu.setAttribute('aria-hidden', String(!open));
          });
          document.addEventListener('click', (e)=>{
            if(!menuDropdown.contains(e.target) && menuDropdown.classList.contains('open')){
              menuDropdown.classList.remove('open');
              menuBtn.setAttribute('aria-expanded', 'false');
              if(menu) menu.setAttribute('aria-hidden','true');
            }
          });
        }
      })();

      // close chat/menu on Escape
      document.addEventListener('keydown', (e)=>{
        if(e.key === 'Escape'){
          const menuDropdown = document.getElementById('menuDropdown');
          if(menuDropdown && menuDropdown.classList.contains('open')){
            menuDropdown.classList.remove('open');
            document.getElementById('menuBtn').setAttribute('aria-expanded','false');
            document.getElementById('menu').setAttribute('aria-hidden','true');
          }
          const chatWindow = document.getElementById('chatWindow');
          if(chatWindow && chatWindow.style.display === 'flex'){
            chatWindow.style.display = 'none';
            chatWindow.setAttribute('aria-hidden','true');
          }
        }
      });
    });
  </script>
</body>

</html>
